<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>マピオンURL → 座標コピー＆マイマップ起動（測地系補正対応）</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; margin: 0; padding: 16px; line-height: 1.6; }
  h1 { font-size: 18px; margin: 0 0 8px; }
  button { font-size: 16px; padding: 12px 16px; width: 100%; }
  .log { margin-top: 12px; font-size: 14px; white-space: pre-wrap; background: #f6f6f6; padding: 10px; border-radius: 8px; }
  .hint { color: #666; font-size: 13px; margin-top: 8px; }
  .fallback { display:none; margin-top:12px; }
  textarea { width:100%; height:100px; font-size:14px; padding:8px; box-sizing:border-box; }
  .steps { margin: 12px 0; font-size:14px; }
  .steps b { display:block; margin-bottom:4px; }
  .opts { margin: 10px 0; font-size: 13px; color:#333; }
  label { user-select:none; }
</style>
</head>
<body>
  <h1>マピオンURL → 座標コピー＆マイマップ起動</h1>

  <div class="steps">
    <b>•操作手順</b>
    ①災害情報MAILの災害地点URLをコピー<br>
    ②本サイトの「実行」ボタンを押す。ペーストを押す<br>
    ③Googleマップが開くので、「ここで検索」をタップしてペーストを選ぶ。<br>
    ④発生場所にピンが立つはず！
  </div>

  <div class="opts">
    <label><input type="checkbox" id="forceTokyo"> 東京測地系補正を強制ON（自動検出が合わない時）</label>
  </div>

  <button id="runBtn">実行</button>
  <div class="hint">※ 先にマピオンのURLをコピーしてから押してな。HTTPS配信が必要（GitHub PagesならOK）。</div>
  <div class="log" id="log">待機中…</div>

  <div class="fallback" id="fallbackBox">
    <p>クリップボードの取得に失敗したので、ここに<strong>マピオンのURLを貼り付け</strong>て「続行」を押してな。</p>
    <textarea id="fallbackInput" placeholder="ここにURLを貼り付け"></textarea>
    <button id="fallbackBtn">続行</button>
  </div>

<script>
  // ★ここを自分のマイマップURLに差し替え（編集/閲覧どちらでも可）
  // 例）"https://www.google.com/maps/d/edit?hl=ja&authuser=0&mid=XXXXXXXXXXXX"
  const MY_MAPS_URL = "https://www.google.com/maps/d/edit?hl=ja&authuser=0&mid=1bsmlEhct96yonZynraZzo3WGYrcriWs";

  const logEl = document.getElementById('log');
  const runBtn = document.getElementById('runBtn');
  const fbBox  = document.getElementById('fallbackBox');
  const fbIn   = document.getElementById('fallbackInput');
  const fbBtn  = document.getElementById('fallbackBtn');
  const forceTokyoChk = document.getElementById('forceTokyo');

  function log(msg) { logEl.textContent = msg; console.log(msg); }

  // 角度 DMS（度/分/秒を "/" 区切り）→ 小数
  function parseMapionAngle(input) {
    const s = String(input ?? '').trim();
    if (!s) return NaN;
    const parts = s.split('/');
    if (parts.length === 3) {
      const d = parseFloat(parts[0]), m = parseFloat(parts[1]), sec = parseFloat(parts[2]);
      return [d,m,sec].every(Number.isFinite) ? d + m/60 + sec/3600 : NaN;
    } else if (parts.length === 2) {
      const d = parseFloat(parts[0]), m = parseFloat(parts[1]);
      return [d,m].every(Number.isFinite) ? d + m/60 : NaN;
    } else {
      const v = parseFloat(s);
      return Number.isFinite(v) ? v : NaN;
    }
  }

  // マピオンURL → 緯度経度抽出（複数フォーマット対応）
  function extractLatLngFromMapion(urlStr) {
    try {
      const u = new URL(urlStr.trim());

      // /m2/{lat},{lng}[,{zoom}]
      if (u.pathname.startsWith('/m2/')) {
        const parts = u.pathname.slice(4).split(',');
        if (parts.length >= 2) {
          const lat = parseFloat(parts[0]), lng = parseFloat(parts[1]);
          if (isFinite(lat) && isFinite(lng)) return { lat, lng, url: u };
        }
      }

      // ?lat=.. &lon=.. / lng=.. / long=..
      const latQ = u.searchParams.get('lat');
      const lonQ = u.searchParams.get('lon') || u.searchParams.get('lng') || u.searchParams.get('long');
      if (latQ && lonQ) {
        const lat = parseFloat(latQ), lng = parseFloat(lonQ);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng, url: u };
      }

      // ?ll=lat,lng
      const ll = u.searchParams.get('ll');
      if (ll) {
        const [a,b] = ll.split(',');
        const lat = parseFloat(a), lng = parseFloat(b);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng, url: u };
      }

      // #...ll=lat,lng
      if (u.hash && u.hash.includes('ll=')) {
        const m = u.hash.match(/ll=([0-9.+-]+),([0-9.+-]+)/);
        if (m) {
          const lat = parseFloat(m[1]), lng = parseFloat(m[2]);
          if (isFinite(lat) && isFinite(lng)) return { lat, lng, url: u };
        }
      }

      // ?nl=36/16/35.98 & el=139/15/34.17（DMS）
      const nl = u.searchParams.get('nl');
      const el = u.searchParams.get('el');
      if (nl && el) {
        const lat = parseMapionAngle(nl);
        const lng = parseMapionAngle(el);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng, url: u, dms: true };
      }

      return null;
    } catch {
      return null;
    }
  }

  // 自動判定：東京測地系っぽいか？
  // ・sasp.mapion.co.jp（旧系）/ nl, el が来たら Tokyo とみなす
  function detectDatum(info) {
    if (!info || !info.url) return 'wgs84';
    const host = info.url.hostname || '';
    if (forceTokyoChk.checked) return 'tokyo';
    if (info.dms) return 'tokyo';
    if (/(^|\.)sasp\.mapion\.co\.jp$/i.test(host)) return 'tokyo';
    return 'wgs84';
  }

  // 東京測地系(Bessel) → WGS84 近似補正（全国向け簡易式）
  // 参考的に広く使われる一次近似：
  // wgsLat = tokyoLat - 0.00010695 * tokyoLat + 0.000017464 * tokyoLon + 0.0046017
  // wgsLon = tokyoLon - 0.000046038 * tokyoLat - 0.000083043 * tokyoLon + 0.010040
  function tokyoToWgs(latTokyo, lonTokyo) {
    const wgsLat = latTokyo - 0.00010695 * latTokyo + 0.000017464 * lonTokyo + 0.0046017;
    const wgsLon = lonTokyo - 0.000046038 * latTokyo - 0.000083043 * lonTokyo + 0.010040;
    return { lat: wgsLat, lng: wgsLon };
  }

  // 測地系正規化（auto: URLを見て自動判定）
  function normalizeToWGS84(lat, lng, datumMode) {
    if (datumMode === 'tokyo') {
      return tokyoToWgs(lat, lng);
    }
    return { lat, lng }; // すでにWGS84想定
  }

  async function copyText(text) {
    try { await navigator.clipboard.writeText(text); return true; }
    catch { return false; }
  }

  function openMyMaps() {
    const w = window.open(MY_MAPS_URL, '_blank', 'noopener');
    if (!w) log('（ポップアップがブロックされたかも。ブラウザの許可を確認してな）');
  }

  async function handleUrl(urlText) {
    const info = extractLatLngFromMapion(urlText);
    if (!info) {
      log('マピオンURLから座標を読み取れませんでした。/m2/形式、lat&lon/ll形式、nl&el形式（DMS）に対応しています。');
      openMyMaps();
      return;
    }
    const datum = detectDatum(info);
    let { lat, lng } = info;
    ({ lat, lng } = normalizeToWGS84(lat, lng, datum));

    const fixedLat = (+lat).toFixed(6), fixedLng = (+lng).toFixed(6);
    const coordStr = `${fixedLat},${fixedLng}`;

    const ok = await copyText(coordStr);
    if (ok) {
      log(`座標をコピーしました：${coordStr}\n（測地系：${datum} → WGS84）\nマイマップを開いています…`);
    } else {
      log(`座標：${coordStr}\n（測地系：${datum} → WGS84）\nクリップボード書き込み失敗。手動コピーしてな。`);
      alert(`座標：${coordStr}`);
    }
    openMyMaps();
  }

  async function runOnce() {
    log('クリップボードからURLを取得中…');
    try {
      const text = await navigator.clipboard.readText();
      if (!text || !/^https?:\/\//i.test(text)) throw new Error();
      await handleUrl(text);
    } catch {
      log('クリップボード読み取り失敗。貼り付けフォールバックを使用してください。');
      fbBox.style.display = 'block'; fbIn.focus();
    }
  }

  runBtn.addEventListener('click', runOnce);
  fbBtn.addEventListener('click', () => {
    const v = fbIn.value.trim();
    if (!v) { alert('URLを貼り付けてください'); return; }
    handleUrl(v);
  });
</script>
</body>
</html>