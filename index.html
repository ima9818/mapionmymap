<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>マピオンURL → 座標コピー＆マイマップ起動（ワンボタン）</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; margin: 0; padding: 16px; line-height: 1.6; }
  h1 { font-size: 18px; margin: 0 0 8px; }
  button { font-size: 16px; padding: 12px 16px; width: 100%; }
  .log { margin-top: 12px; font-size: 14px; white-space: pre-wrap; background: #f6f6f6; padding: 10px; border-radius: 8px; }
  .hint { color: #666; font-size: 13px; margin-top: 8px; }
  .fallback { display:none; margin-top:12px; }
  textarea { width:100%; height:100px; font-size:14px; padding:8px; box-sizing:border-box; }
</style>
</head>
<body>
  <h1>マピオンURL → 座標コピー＆マイマップ起動</h1>
  <button id="runBtn">実行</button>
  <div class="hint">※ 先にマピオンのURLをコピーしてから押してな。HTTPS配信が必要（GitHub PagesならOK）。</div>
  <div class="log" id="log">待機中…</div>

  <div class="fallback" id="fallbackBox">
    <p>クリップボードの取得に失敗したので、ここに<strong>マピオンのURLを貼り付け</strong>て「続行」を押してな。</p>
    <textarea id="fallbackInput" placeholder="ここにURLを貼り付け"></textarea>
    <button id="fallbackBtn">続行</button>
  </div>

<script>
  // ★ここを自分のマイマップURLに差し替え（編集/閲覧どちらでも可）
  // 例）"https://www.google.com/maps/d/edit?hl=ja&authuser=0&mid=XXXXXXXXXXXX"
  const MY_MAPS_URL = "https://www.google.com/maps/d/edit?hl=ja&authuser=0&mid=1bsmlEhct96yonZynraZzo3WGYrcriWs";

  const logEl = document.getElementById('log');
  const runBtn = document.getElementById('runBtn');
  const fbBox  = document.getElementById('fallbackBox');
  const fbIn   = document.getElementById('fallbackInput');
  const fbBtn  = document.getElementById('fallbackBtn');

  function log(msg) { logEl.textContent = msg; console.log(msg); }

  // "36/16/35.98" → 36 + 16/60 + 35.98/3600（DMSを小数に）
  function parseMapionAngle(input) {
    const s = String(input ?? '').trim();
    if (!s) return NaN;
    const parts = s.split('/');
    if (parts.length === 3) {
      const d = parseFloat(parts[0]), m = parseFloat(parts[1]), sec = parseFloat(parts[2]);
      return [d,m,sec].every(Number.isFinite) ? d + m/60 + sec/3600 : NaN;
    } else if (parts.length === 2) {
      const d = parseFloat(parts[0]), m = parseFloat(parts[1]);
      return [d,m].every(Number.isFinite) ? d + m/60 : NaN;
    } else {
      const v = parseFloat(s);
      return Number.isFinite(v) ? v : NaN;
    }
  }

  // マピオンURLから緯度経度を抜く（複数フォーマット対応）
  function extractLatLngFromMapion(urlStr) {
    try {
      const u = new URL(urlStr.trim());

      // 1) /m2/{lat},{lng}[,{zoom}]
      if (u.pathname.startsWith('/m2/')) {
        const parts = u.pathname.slice(4).split(',');
        if (parts.length >= 2) {
          const lat = parseFloat(parts[0]), lng = parseFloat(parts[1]);
          if (isFinite(lat) && isFinite(lng)) return { lat, lng };
        }
      }

      // 2) ?lat=.. &lon=.. / lng=.. / long=..
      const latQ = u.searchParams.get('lat');
      const lonQ = u.searchParams.get('lon') || u.searchParams.get('lng') || u.searchParams.get('long');
      if (latQ && lonQ) {
        const lat = parseFloat(latQ), lng = parseFloat(lonQ);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng };
      }

      // 3) ?ll=lat,lng
      const ll = u.searchParams.get('ll');
      if (ll) {
        const [a,b] = ll.split(',');
        const lat = parseFloat(a), lng = parseFloat(b);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng };
      }

      // 4) #...ll=lat,lng（ハッシュに入ってる場合）
      if (u.hash && u.hash.includes('ll=')) {
        const m = u.hash.match(/ll=([0-9.+-]+),([0-9.+-]+)/);
        if (m) {
          const lat = parseFloat(m[1]), lng = parseFloat(m[2]);
          if (isFinite(lat) && isFinite(lng)) return { lat, lng };
        }
      }

      // 5) ?nl=36/16/35.98 & el=139/15/34.17（度/分/秒を "/" で区切る古い形式）
      const nl = u.searchParams.get('nl');
      const el = u.searchParams.get('el');
      if (nl && el) {
        const lat = parseMapionAngle(nl);
        const lng = parseMapionAngle(el);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng };
      }

      return null;
    } catch {
      return null;
    }
  }

  //（必要なら測地系補正をここで）
  function normalizeToWGS84(lat, lng) {
    return { lat, lng };
  }

  async function copyText(text) {
    try { await navigator.clipboard.writeText(text); return true; }
    catch { return false; }
  }

  function openMyMaps() {
    const w = window.open(MY_MAPS_URL, '_blank', 'noopener');
    if (!w) log('（ポップアップがブロックされたかも。ブラウザの許可を確認してな）');
  }

  async function handleUrl(urlText) {
    const coords = extractLatLngFromMapion(urlText);
    if (!coords) {
      log('マピオンURLから座標を読み取れませんでした。\n対応例：/m2/35.68124,139.76712 もしくは nl/el（36/16/35.98 等）');
      openMyMaps();
      return;
    }
    const { lat, lng } = normalizeToWGS84(coords.lat, coords.lng);
    const fixedLat = (+lat).toFixed(6);
    const fixedLng = (+lng).toFixed(6);
    const coordStr = `${fixedLat},${fixedLng}`;

    const ok = await copyText(coordStr);
    if (ok) {
      log(`座標をコピーしました：${coordStr}\nマイマップを開いています…`);
    } else {
      log(`座標は取得：${coordStr}\nしかしクリップボードに書き込めませんでした。手動でコピーしてください。`);
      alert(`座標：${coordStr}\n（コピーできない場合は長押し→コピー）`);
    }
    openMyMaps();
  }

  async function runOnce() {
    log('クリップボードからURLを取得中…');
    try {
      const text = await navigator.clipboard.readText();
      if (!text || !/^https?:\/\//i.test(text)) throw new Error('クリップボードにURLが無い');
      await handleUrl(text);
    } catch {
      // フォールバックに切り替え
      log('クリップボードの読み取りに失敗。貼り付けフォールバックに切り替えます。');
      fbBox.style.display = 'block';
      fbIn.focus();
    }
  }

  runBtn.addEventListener('click', runOnce);
  fbBtn.addEventListener('click', () => {
    const v = fbIn.value.trim();
    if (!v) { alert('URLを貼り付けてください'); return; }
    handleUrl(v);
  });
</script>
</body>
</html>