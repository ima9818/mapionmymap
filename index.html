<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>マピオンURL → 座標コピー＆マイマップ起動（常時：日本測地系→WGS84補正）</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; margin: 0; padding: 16px; line-height: 1.6; }
  h1 { font-size: 18px; margin: 0 0 8px; }
  button { font-size: 16px; padding: 12px 16px; width: 100%; }
  .log { margin-top: 12px; font-size: 14px; white-space: pre-wrap; background: #f6f6f6; padding: 10px; border-radius: 8px; }
  .hint { color: #666; font-size: 13px; margin-top: 8px; }
  .fallback { display:none; margin-top:12px; }
  textarea { width:100%; height:100px; font-size:14px; padding:8px; box-sizing:border-box; }
  .steps { margin: 12px 0; font-size:14px; }
  .steps b { display:block; margin-bottom:4px; }
  .badge { display:inline-block; font-size:12px; color:#fff; background:#0a7; padding:2px 6px; border-radius:6px; margin-left:6px; }
</style>
</head>
<body>
  <h1>マピオンURL → 座標コピー＆マイマップ起動 <span class="badge"> </span></h1>

  <div class="steps">
    <b>•操作手順</b>
    ①災害情報MAILの災害地点URLをコピー<br>
    ②本サイトの「実行」ボタンを押す。次にペーストを押す<br>
    ③Googleマップが開くので、「ここで検索」をタップしてペーストを選ぶ。<br>
    ④発生場所にピンが立つはず！ナビを開始しないでください。経路検索だけにしてください、現着した時に、現在地から火点までの距離がわかるはずです。上手くいかなかったら最初からやり直して。ナビ開始すると水利マップが消えちゃうよん。
  </div>

  <button id="runBtn">実行</button>
  <div class="hint">※ 先にマピオンのURLをコピーしてから押してな。HTTPS配信が必要（GitHub PagesならOK）。</div>
  <div class="log" id="log">待機中…</div>

  <div class="fallback" id="fallbackBox">
    <p>クリップボードの取得に失敗したので、ここに<strong>マピオンのURLを貼り付け</strong>て「続行」を押してな。</p>
    <textarea id="fallbackInput" placeholder="ここにURLを貼り付け"></textarea>
    <button id="fallbackBtn">続行</button>
  </div>

<script>
  // ★あなたのマイマップURLに差し替え（閲覧用 or 編集用）
  // 例）"https://www.google.com/maps/d/edit?hl=ja&authuser=0&mid=XXXXXXXXXXXX"
  const MY_MAPS_URL = "https://www.google.com/maps/d/edit?hl=ja&authuser=0&mid=1bsmlEhct96yonZynraZzo3WGYrcriWs";

  const logEl = document.getElementById('log');
  const runBtn = document.getElementById('runBtn');
  const fbBox  = document.getElementById('fallbackBox');
  const fbIn   = document.getElementById('fallbackInput');
  const fbBtn  = document.getElementById('fallbackBtn');

  const isAndroid = /Android/i.test(navigator.userAgent);
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

  function log(msg) { logEl.textContent = msg; console.log(msg); }

  // "36/16/35.98" → 36 + 16/60 + 35.98/3600（DMS→小数）
  function parseMapionAngle(input) {
    const s = String(input ?? '').trim();
    if (!s) return NaN;
    const parts = s.split('/');
    if (parts.length === 3) {
      const d = parseFloat(parts[0]), m = parseFloat(parts[1]), sec = parseFloat(parts[2]);
      return [d,m,sec].every(Number.isFinite) ? d + m/60 + sec/3600 : NaN;
    } else if (parts.length === 2) {
      const d = parseFloat(parts[0]), m = parseFloat(parts[1]);
      return [d,m].every(Number.isFinite) ? d + m/60 : NaN;
    } else {
      const v = parseFloat(s);
      return Number.isFinite(v) ? v : NaN;
    }
  }

  // マピオンURL → 緯度経度抽出（複数フォーマット対応）
  function extractLatLngFromMapion(urlStr) {
    try {
      const u = new URL(urlStr.trim());

      // 1) /m2/{lat},{lng}[,{zoom}]
      if (u.pathname.startsWith('/m2/')) {
        const parts = u.pathname.slice(4).split(',');
        if (parts.length >= 2) {
          const lat = parseFloat(parts[0]), lng = parseFloat(parts[1]);
          if (isFinite(lat) && isFinite(lng)) return { lat, lng };
        }
      }

      // 2) ?lat=.. &lon=.. / lng=.. / long=..
      const latQ = u.searchParams.get('lat');
      const lonQ = u.searchParams.get('lon') || u.searchParams.get('lng') || u.searchParams.get('long');
      if (latQ && lonQ) {
        const lat = parseFloat(latQ), lng = parseFloat(lonQ);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng };
      }

      // 3) ?ll=lat,lng
      const ll = u.searchParams.get('ll');
      if (ll) {
        const [a,b] = ll.split(',');
        const lat = parseFloat(a), lng = parseFloat(b);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng };
      }

      // 4) #...ll=lat,lng（ハッシュ）
      if (u.hash && u.hash.includes('ll=')) {
        const m = u.hash.match(/ll=([0-9.+-]+),([0-9.+-]+)/);
        if (m) {
          const lat = parseFloat(m[1]), lng = parseFloat(m[2]);
          if (isFinite(lat) && isFinite(lng)) return { lat, lng };
        }
      }

      // 5) ?nl=36/16/35.98 & el=139/15/34.17（DMS古形式）
      const nl = u.searchParams.get('nl');
      const el = u.searchParams.get('el');
      if (nl && el) {
        const lat = parseMapionAngle(nl);
        const lng = parseMapionAngle(el);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng };
      }

      return null;
    } catch {
      return null;
    }
  }

  // 日本測地系(Tokyo/Bessel) → WGS84 近似補正（全国向け一次近似）
  function tokyoToWgs(latTokyo, lonTokyo) {
    const wgsLat = latTokyo - 0.00010695 * latTokyo + 0.000017464 * lonTokyo + 0.0046017;
    const wgsLon = lonTokyo - 0.000046038 * latTokyo - 0.000083043 * lonTokyo + 0.010040;
    return { lat: wgsLat, lng: wgsLon };
  }

  async function copyText(text) {
    try { await navigator.clipboard.writeText(text); return true; }
    catch { return false; }
  }

  // --- ここから「アプリで開く」3段フォールバック ---
  // ① まずは My Maps のユニバーサルリンクを試す（運が良ければアプリが拾う）
  function tryOpenMyMapsUniversal() {
    const a = document.createElement('a');
    a.href = MY_MAPS_URL;
    a.rel = 'noopener';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // ② だめなら座標で“アプリ”を強制起動（iOS/Android別）
  function openMapsAppWithCoords(lat, lng) {
    const q = `${lat},${lng}`;

    if (isIOS) {
      // iOS: Google Maps アプリ URLスキーム
      // 端末にインストールされていない場合は無反応になることがあるので、
      // 少し待ってWebフォールバックへ
      window.location.href = `comgooglemaps://?q=${encodeURIComponent(q)}&center=${encodeURIComponent(q)}&zoom=17`;
    } else if (isAndroid) {
      // Android: intent でGoogleマップアプリを指名起動
      const intentUrl = `intent://maps.google.com/?q=${encodeURIComponent(q)}#Intent;scheme=https;package=com.google.android.apps.maps;end`;
      const a = document.createElement('a');
      a.href = intentUrl;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    } else {
      // PC等はWeb
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank', 'noopener');
    }
  }

  // ③ 最後の保険：My Maps（Web）を開く
  function openMyMapsWeb() {
    window.open(MY_MAPS_URL, '_blank', 'noopener');
  }

  // 実行シーケンス：My Mapsユニバーサル → 少し待って座標でアプリ → さらに保険でWeb
  function openMyMapPreferApp(lat, lng) {
    tryOpenMyMapsUniversal();

    // 350ms後に座標でアプリ起動を試行（ユニバーサルが失敗した場合の保険）
    setTimeout(() => {
      openMapsAppWithCoords(lat, lng);
    }, 350);

    // さらに700ms後にWebを開く（アプリが起動しなかった端末向けの最終フォールバック）
    setTimeout(() => {
      openMyMapsWeb();
    }, 1050);
  }
  // --- フォールバックここまで ---

  async function handleUrl(urlText) {
    const coords = extractLatLngFromMapion(urlText);
    if (!coords) {
      log('マピオンURLから座標を読み取れませんでした。/m2/形式、lat&lon/ll形式、nl&el形式（DMS）に対応しています。');
      // 読み取れなくてもMy Mapsは開いておく
      openMyMapsWeb();
      return;
    }

    // 常時：日本測地系→WGS84へ補正
    const { lat: wgsLat, lng: wgsLng } = tokyoToWgs(coords.lat, coords.lng);
    const lat6 = (+wgsLat).toFixed(6), lng6 = (+wgsLng).toFixed(6);
    const coordStr = `${lat6},${lng6}`;

    const ok = await copyText(coordStr);
    if (ok) {
      log(`座標をコピーしました：${coordStr}\n（Tokyo→WGS84 補正済み）\nマイマップをアプリ優先で開きます…`);
    } else {
      log(`座標：${coordStr}\n（Tokyo→WGS84 補正済み）\nクリップボード書き込み失敗。手動コピーしてな。`);
      alert(`座標：${coordStr}`);
    }

    // アプリ優先で開く（ユニバーサル→座標deep link→Web）
    openMyMapPreferApp(lat6, lng6);
  }

  async function runOnce() {
    log('クリップボードからURLを取得中…');
    try {
      const text = await navigator.clipboard.readText();
      if (!text || !/^https?:\/\//i.test(text)) throw new Error();
      await handleUrl(text);
    } catch {
      log('クリップボード読み取り失敗。貼り付けフォールバックを使用してください。');
      fbBox.style.display = 'block'; fbIn.focus();
    }
  }

  runBtn.addEventListener('click', runOnce);
  fbBtn.addEventListener('click', () => {
    const v = fbIn.value.trim();
    if (!v) { alert('URLを貼り付けてください'); return; }
    handleUrl(v);
  });
</script>
</body>
</html>