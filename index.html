<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>マピオンURL → 座標コピー＆マイマップ起動（ワンボタン）</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; margin: 0; padding: 16px; line-height: 1.6; }
  h1 { font-size: 18px; margin: 0 0 8px; }
  button { font-size: 16px; padding: 12px 16px; width: 100%; }
  .log { margin-top: 12px; font-size: 14px; white-space: pre-wrap; background: #f6f6f6; padding: 10px; border-radius: 8px; }
  .hint { color: #666; font-size: 13px; margin-top: 8px; }
</style>
</head>
<body>
  <h1>マピオンURL → 座標コピー＆マイマップ起動</h1>
  <button id="runBtn">実行</button>
  <div class="hint">※ 先にマピオンのURLをコピーしてから押してな。</div>
  <div class="log" id="log">待機中…</div>

<script>
  // ★あなたのマイマップURLに置き換えてください
const MY_MAPS_URL = "https://www.google.com/maps/d/edit?hl=ja&authuser=0&mid=1bsmlEhct96yonZynraZzo3WGYrcriWs";

  const logEl = document.getElementById('log');
  const runBtn = document.getElementById('runBtn');

  function log(msg) {
    logEl.textContent = msg;
    console.log(msg);
  }

  // マピオンURLから緯度経度を頑丈めに抜く関数
  function extractLatLngFromMapion(urlStr) {
    try {
      const u = new URL(urlStr);

      // 1) /m2/{lat},{lng}[,{zoom}] 形式
      // 例: https://www.mapion.co.jp/m2/35.68124,139.76712,17
      if (u.pathname.startsWith('/m2/')) {
        const tail = u.pathname.replace('/m2/', '');
        const parts = tail.split(',');
        if (parts.length >= 2) {
          const lat = parseFloat(parts[0]);
          const lng = parseFloat(parts[1]);
          if (isFinite(lat) && isFinite(lng)) return { lat, lng };
        }
      }

      // 2) クエリに lat / lon（または ll）系がある場合
      // 例: ?lat=35.6&lon=139.6 / ?ll=35.6,139.6
      const latQ = u.searchParams.get('lat');
      const lonQ = u.searchParams.get('lon') || u.searchParams.get('lng') || u.searchParams.get('long');
      if (latQ && lonQ) {
        const lat = parseFloat(latQ);
        const lng = parseFloat(lonQ);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng };
      }
      const ll = u.searchParams.get('ll');
      if (ll) {
        const [latS, lngS] = ll.split(',');
        const lat = parseFloat(latS);
        const lng = parseFloat(lngS);
        if (isFinite(lat) && isFinite(lng)) return { lat, lng };
      }

      // 3) ハッシュに ll=35.6,139.6 がある場合
      if (u.hash && u.hash.includes('ll=')) {
        const m = u.hash.match(/ll=([0-9.+-]+),([0-9.+-]+)/);
        if (m) {
          const lat = parseFloat(m[1]);
          const lng = parseFloat(m[2]);
          if (isFinite(lat) && isFinite(lng)) return { lat, lng };
        }
      }

      // 必要に応じて他のパターンを追加
      return null;
    } catch {
      return null;
    }
  }

  // 必要なら東京測地系→世界測地系の変換を入れるためのフック（今は素通し）
  function normalizeToWGS84(lat, lng, datumHint) {
    // もし datumHint === 'tokyo' などを検出できるなら、ここで補正（約+0.00010695φ - 0.000017464λ 等）
    // ただし多くの現行マピオンURLはWGS84想定でOK
    return { lat, lng };
  }

  async function runOnce() {
    log('クリップボードからURLを取得中…');
    let text;
    try {
      text = await navigator.clipboard.readText();
    } catch (e) {
      log('クリップボードの読み取りに失敗しました。HTTPSで開いているか、権限が許可されているか確認してください。\n' +
          '（iOS Safari等では一部制限が厳しいです。必要なら一時的にテキストエリア貼り付け式のフォールバックを足せます）\n' +
          'エラー: ' + e);
      return;
    }

    if (!text || !/^https?:\/\//i.test(text)) {
      log('クリップボードにURLが見つかりませんでした。先にマピオンのURLをコピーしてからボタンを押してな。');
      return;
    }

    const coords = extractLatLngFromMapion(text.trim());
    if (!coords) {
      log('マピオンURLから座標を読み取れませんでした。\nURL形式がいつもと違う可能性があります。\n例）/m2/35.XXXX,139.XXXX の形式に対応しています。');
      return;
    }

    const { lat, lng } = normalizeToWGS84(coords.lat, coords.lng);
    const fixedLat = (+lat).toFixed(6);
    const fixedLng = (+lng).toFixed(6);
    const coordStr = `${fixedLat},${fixedLng}`;

    try {
      await navigator.clipboard.writeText(coordStr);
      log(`座標をコピーしました：${coordStr}\nマイマップを開いています…`);
    } catch (e) {
      log(`座標は取得できましたがクリップボードへの書き込みに失敗：${coordStr}\nエラー: ${e}\n（ブラウザ権限を確認してください）`);
    }

    // マイマップを新規タブで開く
    window.open(MY_MAPS_URL, '_blank', 'noopener');
  }

  runBtn.addEventListener('click', () => {
    runOnce();
  });
</script>
</body>
</html>
